# Telegram Бот с поддержкой стороннего API
## О проекте

#### Описание
Данное приложение представляет собой асинхронного, поддерживающего вебхуки, тг-бота написанного на __Python3.12__ с использованием фреймворка [__aiogram 3.20__](https://docs.aiogram.dev/en/v3.20.0/).  
Его целью было создание удобного интерфейса для взаимодействия с внешними API. И с этой задачей он справляется на ура,
предоставляя широкие возможности для конфигурации и масштабирования.

### Интеграции
На данный момент интегрирован с https://jsonplaceholder.typicode.com  
Это отличный вариант для демонстрации возможностей или же проверки новых "фич".  

### Использование
Достаточно прост в эксплуатации, и все за счет имеющихся в нем библиотек, которые помогают облегчить многие аспекты работы:
+ ORM SQLAlchemy - Незаменимый помощник в работе с БД. Также настроен на асинхронную работу.
+ Pydantic - Крайне удобный способ валидации данных, как JSON от API, так и объектов ORM-Моделей.
+ Injectable - Один из лучших инструментов для работы с зависимостями в коде.
+ Aiohttp - Поддерживаемый Aiogram фреймворк, который позволяет принимать HTTP-запросы от Telegram,  
тем самым реализуя механизм Webhook'а.

### Вебхуки
В проекте предусмотрена настройка Nginx сервера для проксирования __*HTTPS*__ запросов.  
SSL-сертификаты получаются через ["Let's Encrypt!"](https://letsencrypt.org/ru/getting-started/) и импортируются внутрь Docker-контейнера.

### Сохранение данных
Для хранения всех запросов пользователей используется База данных PostgreSQL.  
Помимо нее, настроена работа с Google Sheets, позволяя по API отправлять результаты работы.

## Установка
*__Рекомендую следовать данным шагам.__*

### Git
Для клонирования репозитория выполните:  
`git clone https://github.com/X-KRAB-X/Bot-task.git`

### Переменные окружения
Первое, что необходимо сделать после клонирования репозитория - создать файл .env в корневой директории:  
`cd Bot-task`  
`touch .env`  

На данный момент имеется 5 пар "ключ=значение":  
+ *BOT_TOKEN* - Токен вашего бота (За ним обращаться к [BotFather](https://telegram.me/botfather))
+ *DOMAIN_NAME* - Ваше доменное имя, на которое у вас оформлен сертификат. По нему ТГ будет слать вебхуки.
+ *GOOGLE_KEY_NAME* - Ключ к Google таблице
+ *SPREADSHEET_ID* - ID Google таблицы
+ *DATABASE_URL* - <u>*Опционально*</u>. Если указать в данном ключе URL удаленной БД PostgreSQL, бот будет работать именно с ней.  
Если же оставить по умолчанию - работа будет вестись с отдельным [Docker-образом](https://hub.docker.com/_/postgres), локально внутри контейнера.

Для подсказок используйте `.env.template`

### Google Sheets API

С чего стоить начать, так это обзавестись ключом доступа. Он представляет из себя .json файл.  
Получить его можно следующим образом:
1. Создать проект на платформе [Google Cloud](https://console.cloud.google.com)
2. Во вкладке IAM & Admin -> IAM создать сервисный аккаунт с правами "Owner" (__Запомните его email__).
3. Создать и загрузить ключ (Нужный нам json). Для него в корне проекта создаем папку "GH" `mkdir ./GH` и помещаем его туда. 
Эта директория находится в .gitignore по соображениям безопасности, так что создаем вручную.  
<u>__Важно!__</u> Название этого файла указываем в `.env ` под ключом *GOOGLE_KEY_NAME*, например example-123.json
4. Перейти на [Google Sheets](https://docs.google.com/spreadsheets) и создать новую таблицу с любым названием. (Или берем имеющуюся)  
В настройках доступа добавляем email нашего нового сервисного аккаунта.
5. Осталось получить ID нашей таблицы. Сделать это можно обратившись к ее URL.  
`https://docs.google.com/spreadsheets/d/<ЗДЕСЬ>/edit`  
Этот ID также записываем в .env под ключом *SPREADSHEET_ID*  

Готово! Теперь бот сможет обращаться к вашей таблице.

### Nginx
Для работы с ним в директории `nginx/` имеется файл с настройками для проксирования HTTPS запросов.  
Этот файл будет импортирован и размещен внутри Docker-контейнера.  

#### SSL
Подразумевается, что вы уже воспользовались ["Let's Encrypt!"](https://letsencrypt.org/ru/getting-started/) и получили сертификат на указанный в `.env` домен.
Если же это не так, рекомендую перейти по ссылке.

После создания файлов `fullchain.pem` и `privkey.pem` необходимо создать в директории `nginx/` новую папку `certs/`  
```bash
cd nginx
mkdir certs
chmod 700 certs
```
__Важно!__ Запускать контейнер необходимо через `sudo`. Так ключ и цепь гарантированно попадут в контейнер.

## Внутреннее устройство  
Здесь описано то, как модули приложения взаимодействуют друг с другом.  
Индивидуальное описание находится внутри каждого из них.

### Запуск
Все начинается с внедрения настроек `config.py` в бота.  
После этого идет настройка всех составляющих приложения:
+ Создание листов Google Sheets
+ Создание таблиц БД
+ Регистрация middleware для обращения к БД и GH
+ Установка вебхука
+ Инициализация веб-приложения aiohttp

После этого бот готов к работе.

### Обработчики (Handlers)
Ключевое звено любого бота.  
Делятся на стандартные(default) и специализированные(custom).  

#### default
Принимают на себя простые команды, такие как `/start` и `/help`.

#### custom
Данный модуль организует работу с командой `/get`, или проще сказать - связывает функционал воедино.
В это входит:
+ Работа с состояниями и клавиатурой
+ Отправка запросов к API
+ Отправка запросов Google Sheets и PostgreSQL через middleware

### Middlewares
Предоставляет обработчикам доступ к БД и GH без необходимости импорта и т.п.
Инициализирует внутри себя 2 сервиса: Для PostgreSQL и для Google Sheets

### Services

#### service/google_sheets
Данный модуль предоставляет методы по созданию записей в листах эл. таблицы.  
Все работает асинхронно.

#### service/db
По аналогии с предыдущим сервисом - предоставляет все необходимое для простой работы с БД.  

### Models

#### models/db, models/google_sheets
Здесь принципы также схожи, поэтому опишу их вместе:
+ Инициализация движка
+ Определение внутреннего устройства таблиц\листов
+ Методы для их создания

#### models/pydantic
Является промежуточным звеном между сервисами и API.
Предоставляет необходимые модели для валидации и трансформации как JSON-ответов API,  
так и ORM-объектов. Сервисы используют их в своей работе.


Вот так мы спустились от самого верха приложения - старта приложения, до самого низу - внутренностей проекта.

## Технологии
+ ### Aiogram: 3.20 [[Docs]](https://docs.aiogram.dev/en/v3.20.0/)
+ ### SQLAlchemy: 2.0 [[Docs]](https://docs.sqlalchemy.org/en/20/)
+ ### Gspread: 6.2 [[Docs]](https://pypi.org/project/gspread/)
+ ### Pydantic: 2.10 [[Docs]](https://docs.pydantic.dev/2.10/)
+ ### Injectable: 4.0 [[Docs]](https://injectable.readthedocs.io/en/4.0.1/)
